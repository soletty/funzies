"use client";

import { useCallback, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { useAssembly, useAssemblyId, useAssemblyAccess } from "@/lib/assembly-context";
import SharePanel from "@/components/SharePanel";
import type { Topic } from "@/lib/types";

function truncate(text: string, max: number): string {
  if (text.length <= max) return text;
  return text.slice(0, max - 1) + "\u2026";
}

function cleanTitle(title: string): string {
  return title.replace(/\s*â€”\s*Final.*$/, "").replace(/\s*--\s*Assembly.*$/, "");
}

function isSocrate(name: string): boolean {
  return name.toLowerCase().includes("socrate");
}

function formatStructure(structure: string): string {
  const names: Record<string, string> = {
    "grande-table": "Town Hall",
    "rapid-fire": "Crossfire",
    "deep-dive": "Deep Dive",
  };
  return (
    names[structure] ??
    structure
      .split("-")
      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
      .join(" ")
  );
}

export function AssemblyNav({ slug }: { topic?: Topic; slug: string }) {
  const topic = useAssembly();
  const assemblyId = useAssemblyId();
  const accessLevel = useAssemblyAccess();
  const pathname = usePathname();
  const [navOpen, setNavOpen] = useState(false);
  const [shareOpen, setShareOpen] = useState(false);

  const base = `/assembly/${slug}`;
  const shortTitle = truncate(cleanTitle(topic.title), 30);

  const isActive = useCallback(
    (path: string) => pathname === path,
    [pathname]
  );

  const closeNav = () => setNavOpen(false);

  useEffect(() => {
    document.body.classList.toggle("nav-open", navOpen);
    return () => document.body.classList.remove("nav-open");
  }, [navOpen]);

  const titleLink = topic.synthesis ? `${base}/synthesis` : base;

  return (
    <>
      <button
        className="nav-hamburger"
        aria-label="Open menu"
        onClick={() => setNavOpen(!navOpen)}
      >
        &#9776;
      </button>
      <div className="nav-overlay" onClick={closeNav} />
      <nav>
        <div className="nav-brand">
          <div className="nav-brand-icon">M</div>
          Million Minds
        </div>

        <Link href="/" onClick={closeNav}>
          <span className="nav-icon">&#9776;</span> Home
        </Link>

        <div className="nav-divider" />
        <div className="nav-section">
          <Link href={titleLink} className="nav-section-title" onClick={closeNav}>
            {shortTitle}
          </Link>

          {topic.synthesis && (
            <Link
              href={`${base}/synthesis`}
              className={isActive(`${base}/synthesis`) ? "active" : ""}
              onClick={closeNav}
            >
              <span className="nav-icon">&#9733;</span> Consensus
            </Link>
          )}

          {topic.characters.filter((c) => !isSocrate(c.name)).length > 0 && (
            <Link
              href={`${base}/characters`}
              className={isActive(`${base}/characters`) ? "active" : ""}
              onClick={closeNav}
            >
              <span className="nav-icon">&#9823;</span> The Panel
            </Link>
          )}

          {topic.iterations.map((iter) => (
            <Link
              key={iter.number}
              href={`${base}/iteration/${iter.number}`}
              className={
                isActive(`${base}/iteration/${iter.number}`) ? "active" : ""
              }
              onClick={closeNav}
            >
              <span className="nav-icon">&#9656;</span>{" "}
              {formatStructure(iter.structure)}
            </Link>
          ))}

          {topic.deliverables.length > 0 && (
            <Link
              href={`${base}/deliverables`}
              className={isActive(`${base}/deliverables`) ? "active" : ""}
              onClick={closeNav}
            >
              <span className="nav-icon">&#9998;</span> Deliverables
            </Link>
          )}

          {topic.referenceLibrary && (
            <Link
              href={`${base}/references`}
              className={isActive(`${base}/references`) ? "active" : ""}
              onClick={closeNav}
            >
              <span className="nav-icon">&#9783;</span> Babylon&#39;s Library
            </Link>
          )}

          {(topic.followUps.length > 0 || (topic as Topic & { isComplete?: boolean }).isComplete) && (
            <Link
              href={`${base}/trajectory`}
              className={isActive(`${base}/trajectory`) ? "active" : ""}
              onClick={closeNav}
            >
              <span className="nav-icon">&#8634;</span> Thinking Trail
              {topic.followUps.filter(f => f.insight?.hasInsight).length > 0 && (
                <span className="badge badge-tag" style={{ marginLeft: "0.5rem", fontSize: "0.7rem" }}>
                  {topic.followUps.filter(f => f.insight?.hasInsight).length}
                </span>
              )}
            </Link>
          )}
        </div>

        {accessLevel === "owner" && (
          <>
            <div className="nav-divider" />
            <button
              className="nav-share-btn"
              onClick={() => { setShareOpen(true); closeNav(); }}
            >
              <span className="nav-icon">&#8618;</span> Share
            </button>
          </>
        )}
      </nav>

      {shareOpen && (
        <SharePanel assemblyId={assemblyId} onClose={() => setShareOpen(false)} />
      )}
    </>
  );
}
